{
  "hash": "4cca61508a30e17380e31b758cb0c546",
  "result": {
    "markdown": "---\ntitle: \"First attempt at modelling using Julia\"\nauthor: \"Arno V\"\ndate: \"2023-02-04\"\ncategories: [julia, code, analysis, economics]\nimage: \"julialogo.png\"\n---\n\n# A first attempt at modelling using Julia\n\n‚ú® Economic data üìä , Julia ü§ó and Jupyterü™ê\n\n<p align=\"center\">\n  <img src=\"https://julialang.org/assets/infra/logo.svg\" />\n</p>\n\nThe setup : libs & data\n\n::: {.cell context='setup' execution_count=1}\n``` {.julia .cell-code}\nusing DataFrames, DataFramesMeta, BrowseTables, Parquet\nusing Distributions, StatsPlots, Statistics\nusing Plots\nusing LaTeXStrings\n```\n:::\n\n\n<br>\n\nImporting the data\n\n::: {.cell context='data' execution_count=2}\n``` {.julia .cell-code}\ndf = DataFrame(\n    read_parquet(\"C:\\\\Users\\\\arnov\\\\Documents\\\\code\\\\notebooks\\\\quarto\\\\econ\\\\data\\\\data-clean-full-latest.parquet\"))\n\nfirst(df, 10)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div><div style = \"float: left;\"><span>10√ó8 DataFrame</span></div><div style = \"clear: both;\"></div></div><div class = \"data-frame\" style = \"overflow-x: scroll;\"><table class = \"data-frame\" style = \"margin-bottom: 6px;\"><thead><tr class = \"header\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">Row</th><th style = \"text-align: left;\">perc</th><th style = \"text-align: left;\">country</th><th style = \"text-align: left;\">year</th><th style = \"text-align: left;\">rel_income</th><th style = \"text-align: left;\">original</th><th style = \"text-align: left;\">code</th><th style = \"text-align: left;\">num</th><th style = \"text-align: left;\">label</th></tr><tr class = \"subheader headerLastRow\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\"></th><th title = \"Union{Missing, Float64}\" style = \"text-align: left;\">Float64?</th><th title = \"Union{Missing, String}\" style = \"text-align: left;\">String?</th><th title = \"Union{Missing, Int64}\" style = \"text-align: left;\">Int64?</th><th title = \"Union{Missing, Float64}\" style = \"text-align: left;\">Float64?</th><th title = \"Union{Missing, String}\" style = \"text-align: left;\">String?</th><th title = \"Union{Missing, String}\" style = \"text-align: left;\">String?</th><th title = \"Union{Missing, Int64}\" style = \"text-align: left;\">Int64?</th><th title = \"Union{Missing, String}\" style = \"text-align: left;\">String?</th></tr></thead><tbody><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Albania</td><td style = \"text-align: right;\">2017</td><td style = \"text-align: right;\">2.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">2</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Albania</td><td style = \"text-align: right;\">2018</td><td style = \"text-align: right;\">2.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">3</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Albania</td><td style = \"text-align: right;\">2019</td><td style = \"text-align: right;\">2.3</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">4</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Albania</td><td style = \"text-align: right;\">2020</td><td style = \"text-align: right;\">2.5</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">5</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">1995</td><td style = \"text-align: right;\">3.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">6</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">1996</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">7</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">1997</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">8</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">1998</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">9</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">1999</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">10</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: left;\">Austria</td><td style = \"text-align: right;\">2000</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: left;\">D1:First decile</td><td style = \"text-align: left;\">D</td><td style = \"text-align: right;\">1</td><td style = \"text-align: left;\">First decile</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n<br>\n\n\n# What we aim to do\n\nHere we have two values, $Q(p)$ and $p$, where $p$ is a percentile and $Q$ the Quantile function.  \n\nYou could conversely see it as $q$ and $F(q)$, where $q$ is a quantile and $F$ the CDF.\n\nWe want to find a decent model for $F$. We'll try a few methods first:\n\n* The classic Q-Q plot eyeballing\n* The Kolmogorov-Smirnov test (based on the $L_\\infty$ norm $||F-\\hat{F}||_\\infty$)\n* The so-called Anderson-Darling test (based on the $L_2$ norm $||F-\\hat{F}||_2$)\n\nLet's first look at the data: the true model actually depends on $\\langle t, k, p \\rangle$ (time, country and percentile), but we'll ignore that for now.\n\n::: {.cell context='data' execution_count=3}\n``` {.julia .cell-code}\ndfg = groupby(df, :rel_income)\n\ndfr = hcat(\n    combine(dfg,\n        :perc => ((p) -> quantile(p, 0.025)) => :perc_025,\n        :perc => ((p) -> quantile(p, 0.05)) => :perc_05,\n        :perc => ((p) -> quantile(p, 0.25)) => :perc_25,\n        :perc => ((p) -> quantile(p, 0.5)) => :perc_50,\n        :perc => ((p) -> quantile(p, 0.75)) => :perc_75,\n        :perc => ((p) -> quantile(p, 0.95)) => :perc_95,\n        :perc => ((p) -> quantile(p, 0.975)) => :perc_975,\n        ),\n    combine(dfg,\n        :perc => mean => :perc_mean,\n        :perc => std => :perc_std,\n        ),\n        makeunique=true\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<div><div style = \"float: left;\"><span>506√ó11 DataFrame</span></div><div style = \"float: right;\"><span style = \"font-style: italic;\">481 rows omitted</span></div><div style = \"clear: both;\"></div></div><div class = \"data-frame\" style = \"overflow-x: scroll;\"><table class = \"data-frame\" style = \"margin-bottom: 6px;\"><thead><tr class = \"header\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">Row</th><th style = \"text-align: left;\">rel_income</th><th style = \"text-align: left;\">perc_025</th><th style = \"text-align: left;\">perc_05</th><th style = \"text-align: left;\">perc_25</th><th style = \"text-align: left;\">perc_50</th><th style = \"text-align: left;\">perc_75</th><th style = \"text-align: left;\">perc_95</th><th style = \"text-align: left;\">perc_975</th><th style = \"text-align: left;\">rel_income_1</th><th style = \"text-align: left;\">perc_mean</th><th style = \"text-align: left;\">perc_std</th></tr><tr class = \"subheader headerLastRow\"><th class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\"></th><th title = \"Union{Missing, Float64}\" style = \"text-align: left;\">Float64?</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Union{Missing, Float64}\" style = \"text-align: left;\">Float64?</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th><th title = \"Float64\" style = \"text-align: left;\">Float64</th></tr></thead><tbody><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">1</td><td style = \"text-align: right;\">2.0</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.95</td><td style = \"text-align: right;\">0.95</td><td style = \"text-align: right;\">0.97</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">2.0</td><td style = \"text-align: right;\">0.887081</td><td style = \"text-align: right;\">0.238359</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">2</td><td style = \"text-align: right;\">2.3</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.44</td><td style = \"text-align: right;\">0.96</td><td style = \"text-align: right;\">0.97</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">2.3</td><td style = \"text-align: right;\">0.925874</td><td style = \"text-align: right;\">0.193118</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">3</td><td style = \"text-align: right;\">2.5</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.97</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">2.5</td><td style = \"text-align: right;\">0.914111</td><td style = \"text-align: right;\">0.228064</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">4</td><td style = \"text-align: right;\">3.0</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">3.0</td><td style = \"text-align: right;\">0.58037</td><td style = \"text-align: right;\">0.442832</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">5</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">4.0</td><td style = \"text-align: right;\">0.327748</td><td style = \"text-align: right;\">0.36602</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">6</td><td style = \"text-align: right;\">3.5</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.9995</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.5</td><td style = \"text-align: right;\">0.466774</td><td style = \"text-align: right;\">0.434103</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">7</td><td style = \"text-align: right;\">3.6</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.15</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.6</td><td style = \"text-align: right;\">0.432571</td><td style = \"text-align: right;\">0.42075</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">8</td><td style = \"text-align: right;\">3.8</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.8</td><td style = \"text-align: right;\">0.474231</td><td style = \"text-align: right;\">0.436471</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">9</td><td style = \"text-align: right;\">3.4</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.4</td><td style = \"text-align: right;\">0.564386</td><td style = \"text-align: right;\">0.440106</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">10</td><td style = \"text-align: right;\">3.3</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.994</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.3</td><td style = \"text-align: right;\">0.491507</td><td style = \"text-align: right;\">0.443608</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">11</td><td style = \"text-align: right;\">3.2</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.2</td><td style = \"text-align: right;\">0.603625</td><td style = \"text-align: right;\">0.439773</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">12</td><td style = \"text-align: right;\">3.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.98</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">3.1</td><td style = \"text-align: right;\">0.661707</td><td style = \"text-align: right;\">0.429311</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">13</td><td style = \"text-align: right;\">3.7</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.1</td><td style = \"text-align: right;\">0.99</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">3.7</td><td style = \"text-align: right;\">0.379474</td><td style = \"text-align: right;\">0.406705</td></tr><tr><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td><td style = \"text-align: right;\">&vellip;</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">495</td><td style = \"text-align: right;\">39.3</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">39.3</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">496</td><td style = \"text-align: right;\">35.8</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">35.8</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">497</td><td style = \"text-align: right;\">34.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">34.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">498</td><td style = \"text-align: right;\">37.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">37.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">499</td><td style = \"text-align: right;\">37.6</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">37.6</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">500</td><td style = \"text-align: right;\">36.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">36.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">501</td><td style = \"text-align: right;\">33.6</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">33.6</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">502</td><td style = \"text-align: right;\">33.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">33.2</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">503</td><td style = \"text-align: right;\">33.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">33.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">NaN</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">504</td><td style = \"text-align: right;\">34.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">34.1</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">NaN</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">505</td><td style = \"text-align: right;\">32.3</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">32.3</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">NaN</td></tr><tr><td class = \"rowNumber\" style = \"font-weight: bold; text-align: right;\">506</td><td style = \"text-align: right;\">49.5</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">49.5</td><td style = \"text-align: right;\">1.0</td><td style = \"text-align: right;\">0.0</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n<br>\n\n\n### Confidence intervals\n\nLet's estimate upper and lower confidence bounds for the CDF function $F$.\n\n::: {.cell execution_count=4}\n``` {.julia .cell-code}\ndfr = hcat(\n    dfr,\n    combine(dfr,\n        [:perc_mean, :perc_std] => ByRow.((m,s) -> m + 2 * s) => :perc_upper_std,\n        [:perc_mean, :perc_std] => ByRow.((m,s) -> m - 2 * s) => :perc_lower_std\n        ),\n    makeunique=true\n)\ndfr = select(dfr, Not(:rel_income_1))\n\n\nlatexstring(raw\"\"\"\n\\mu(P) = \"\"\" * \"$(round(mean(df.perc), digits=2))\" * raw\"\"\"\\quad \\text{and} \\quad\n\\sigma(P) = \"\"\" * \"$(round(std(df.perc), digits=2))\" )\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n$\\mu(P) = 0.57\\quad \\text{and} \\quad\n\\sigma(P) = 0.36$\n:::\n:::\n\n\n<br>\n\nThis means that on aggregate we have this mental picture of the typical quartile distribution:\n\n::: {.cell execution_count=5}\n``` {.julia .cell-code}\nmu = round(mean(df.perc), digits=2)\n\nsigma = round(std(df.perc), digits=2)\n\nplot(\n    Normal(\n        mu,\n        sigma\n        ),\n        fill=(0, .2, :pink),\n        linecolor=:purple,\n        label=\"\"\"Normal plot \\\\mu = $(mu), \\\\sigma = $(sigma)\"\"\",\n        size=(800, 600),\n        background_color=\"#7711d708\"\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n![](index_files/figure-html/cell-6-output-1.svg){}\n:::\n:::\n\n\nBut that aggregate picture is not very useful. Let's look at the distribution by relative income.\n\n::: {.cell execution_count=6}\n``` {.julia .cell-code}\nfunction linspace(start::Any, stop::Any, n::Int)\n    step = (stop - start) / (n - 1)\n    return start:step:stop\nend\n\nfunction diracPlot(x, y, label = \"\")\n    plot!([x,x],[0,y],arrow=true,linewidth=2, label=label)\nend\n\nbins = linspace(minimum(df.rel_income), maximum(df.rel_income), 5)\n\ndfbin = combine(df,\n    :rel_income => ByRow.((x) -> bins[findfirst(bins .>= x)]) => :bin_rel_income,\n    :perc => identity => :perc\n    )\n\ndfgbin = combine(\n    groupby(dfbin, :bin_rel_income),\n    :perc => mean => :perc_mean,\n    :perc => std => :perc_std\n    )\n\np = plot(\n    vline(\n        [mean(df.perc)],\n        label=\"Total Mean\",\n        linestyle=:dash,\n        linewidth=2,\n        ylims=(0, 2.5),\n        legend=:outertopright,\n        background_color=\"#7711d708\"\n        ),\n)\nfor i in 1:size(dfgbin, 1)\n    sstd = dfgbin[i, :perc_std]\n    smean = dfgbin[i, :perc_mean]\n    bin_rel_inc = bins[i]\n    if isnan(sstd) || sstd <= 1e-6\n        diracPlot(smean, 2, \"Group $(i) \\\\mu = $(round(smean, digits=2)) , \\\\sigma = 0\")\n        sstd = 0\n    else\n        vline!(\n        [smean],\n        label=\"\",\n        linewidth=0.5,\n        ylims=(0, 2.5),\n        )\n        plot!(\n        Normal(\n            smean,\n            sstd\n            ),\n            fill=(0, .2),\n            label=\"Group $(i) Normal \\\\mu = $(round(smean, digits=2)), \\\\sigma = $(round(sstd, digits=2))\",\n            size=(800, 600),\n            background_color=\"#7711d708\"\n    )\n    end\n    \nend\n\n@show p\n```\n\n::: {.cell-output .cell-output-stdout}\n```\np = Plot{Plots.GRBackend() n=9}\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=7}\n![](index_files/figure-html/cell-7-output-2.svg){}\n:::\n:::\n\n\n<br>\n\nThis is just us toying around with the data though, let us now plot the CDF function $F$ and the confidence bounds.  \n\nThose confidence bounds are not very realistic because we treat a variable that's bounded within $(0,1)$ as if it were normally distributed. But it's a good enough approximation for our purposes.\n\n::: {.cell execution_count=7}\n``` {.julia .cell-code}\n_dfr = dropmissing(sort(dfr, :rel_income))\n\nplot(\n    _dfr.rel_income,\n    _dfr.perc_mean,\n    ribbon=(_dfr.perc_lower_std, _dfr.perc_upper_std),\n    fillalpha=0.2,\n    fillcolor=:blue,\n    label=\"\",\n    xlabel=\"Relative income\",\n    ylabel=L\"Share of population (cdf $\\hat{F}$)\",\n    title=\"Share of population by relative income\",\n    legend=:bottomright,\n    size=(800, 600),\n    ylims=(0, 1.6),\n    xlims=(0, 28),\n    background_color=\"#7711d708\"\n    )\nplot!(\n    _dfr.rel_income,\n    [_dfr.perc_lower_std, _dfr.perc_upper_std],\n    xlims=(0, 28),\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n![](index_files/figure-html/cell-8-output-1.svg){}\n:::\n:::\n\n\n<br>\n\n\nDue to marginalisation across two dimensions, we have a 1D distribution, which we can plot as a curve.\n\nBut we can clearly see the uncertainty around that curve. Let's see the quantiles now üßê\n\n::: {.cell execution_count=8}\n``` {.julia .cell-code}\nplot(\n    _dfr.rel_income,\n    [_dfr.perc_05, _dfr.perc_50, _dfr.perc_95],\n    ribbon=(_dfr.perc_lower_std, _dfr.perc_upper_std),\n    fillalpha=0.2,\n    fillcolor=:blue,\n    label=\"\",\n    xlabel=\"Relative income\",\n    ylabel=L\"Share of population (cdf $\\hat{F}$)\",\n    title=\"Share of population by relative income\",\n    legend=:bottomright,\n    size=(800, 600),\n    ylims=(0, 1.1),\n    xlims=(0, 28),\n    background_color=\"#7711d708\"\n    )\n```\n\n::: {.cell-output .cell-output-display execution_count=9}\n![](index_files/figure-html/cell-9-output-1.svg){}\n:::\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}